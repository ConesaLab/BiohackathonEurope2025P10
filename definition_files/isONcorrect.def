# distribution based on: debian 9.8
Bootstrap:docker
From:debian

# container fo
# Build:
# sudo singularity build  Singularity.seqkit_v0.12.1

%environment
export LC_ALL=C
export LC_NUMERIC=en_GB.UTF-8
export PATH="/opt/miniconda/bin:$PATH"

#%labels
#COPYRIGHT INRAe GAFL 2020
#AUTHOR I2B team
#VERSION 1.1
#LICENSE MIT
#DATE_MODIF MYDATEMODIF

%help
Container for Isoquant

Version: 0.12.1

%runscript
    #default runscript: seq passing all arguments from cli: $@
    exec /opt/isoquant/bin/python3.8 /opt/isoquant/share/isoquant-3.10.0-0/isoquant.py $@

%post

    #essential stuff but minimal
    apt update
    #for security fixe:
    #apt upgrade -y
    apt install -y wget bzip2 curl bash procps cargo

    cd /
    wget https://github.com/aljpetri/isONclust3/archive/refs/tags/isONclust3-0.3.0.tar.gz
    tar -xvzf isONclust3-0.3.0.tar.gz
    ls isON* 
    cd isONclust3-isONclust3-0.3.0
    cargo build --release
    ln -s /isONclust3-isONclust3-0.3.0/target/release/isONclust3 /bin/isONclust3
 
    #install conda
    cd /opt
    rm -fr miniconda

    #miniconda3: get miniconda3 version 4.7.12
    wget https://repo.continuum.io/miniconda/Miniconda3-4.7.12-Linux-x86_64.sh -O miniconda.sh

    #install conda
    bash miniconda.sh -b -p /opt/miniconda
    export PATH="/opt/miniconda/bin:$PATH"
    #add channels
    curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba
    mv bin/micromamba /bin/micromamba
    conda config --add channels defaults
    conda config --add channels bioconda
    conda config --add channels conda-forge

    /bin/micromamba create -c conda-forge -c bioconda -p /opt/isONcorrect python=3.8 pip spoa hmmer>=3.0 pychopper>=2.0 networkx>=2.7.1
    curl -L https://github.com/lh3/minimap2/releases/download/v2.30/minimap2-2.30_x64-linux.tar.bz2 | tar -jxvf - --no-same-owner
    mv ./minimap2-2.30_x64-linux/minimap2 /bin/minimap2
    /bin/micromamba run -p /opt/isONcorrect pip install isONform isONcorrect parasail
    ln -s /opt/isONcorrect/bin/isONcorrect /bin/isONcorrect
    ln -s /opt/isONcorrect/bin/isONform_parallel /bin/isONform_parallel
    #cleanup
    conda clean -y --all
    rm -f /opt/miniconda.sh
    apt autoremove --purge
    apt clean

