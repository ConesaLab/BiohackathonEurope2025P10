Bootstrap: docker
From: debian:latest

%setup

%environment
   MINICONDA_DIR=/root/.miniconda3

%post
    ######################
    # Install Miniconda  #
    ######################
    apt update -y
    apt install wget -y
    mkdir -p /root/.miniconda3
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /root/.miniconda3/miniconda.sh
    chmod +x /root/.miniconda3/miniconda.sh
    /root/.miniconda3/miniconda.sh -b -u -p /root/.miniconda3
    /root/.miniconda3/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
    /root/.miniconda3/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
    rm /root/.miniconda3/miniconda.sh

######################
# Bambu Installation #
######################

%appinstall Bambu
    # Create conda environment and install Bambu
    /root/.miniconda3/bin/conda create -y -n bambu_env
    . /root/.miniconda3/bin/activate bambu_env
    conda install -y -c bioconda -c conda-forge bioconductor-bambu
    R -e "install.packages('xgboost', repos = 'http://cran.us.r-project.org')"


#########################################################################################
# Run as singularity run --app Bambu <sif-file>.sif <script>.R #
######################################################################################### 
%apprun Bambu
    . /root/.miniconda3/bin/activate bambu_env
    Rscript "$@"
